"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const Client_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/Client"));
const Validator_1 = global[Symbol.for('ioc.use')]("Adonis/Core/Validator");
const ResetToken_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Models/ResetToken"));
const EmailService_1 = __importDefault(global[Symbol.for('ioc.use')]("App/Services/EmailService"));
var emailService = new EmailService_1.default();
class AuthController {
    async forgot({ view }) {
        return view.render('auth/forgot');
    }
    async reset({ view }) {
        return view.render('auth/reset');
    }
    async createResetToken({ request, response, session }) {
        try {
            const email = request.input('email');
            if (!email) {
                session.flash({
                    error: "Email is required in the request",
                });
                return response.redirect().back();
            }
            const user = await Client_1.default.findBy('email', email);
            if (!user) {
                session.flash({
                    error: "Invalid email address",
                    email: request.input("email"),
                });
                return response.redirect().back();
            }
            const resetToken = await ResetToken_1.default.createResetToken(email);
            await emailService.passwordRecovery(email, resetToken);
            return response.redirect().toPath("/reset-password");
        }
        catch (error) {
            console.log(error.message);
            session.flash({
                error: "There was a technical error",
                email: request.input("email"),
            });
            return response.redirect().back();
        }
    }
    async processResetToken({ request, response }) {
        try {
            const email = request.input('email');
            const token = request.input('token');
            await ResetToken_1.default.isTokenValid(email, token);
            return response.json({ message: 'Token is valid' });
        }
        catch (error) {
            return response.status(400).json({ message: error.message });
        }
    }
    async updatePasswordWithToken(ctx) {
        try {
            const newPostSchema = Validator_1.schema.create({
                token: Validator_1.schema.string(),
                password: Validator_1.schema.string(),
                confirm_password: Validator_1.schema.string()
            });
            const payload = await ctx.request.validate({ schema: newPostSchema });
            const token = payload.token;
            const password = payload.password;
            const confirmPassword = payload.confirm_password;
            if (password !== confirmPassword) {
                return ctx.response.status(400).json({ message: "Password confirmation does not match." });
            }
            const resetToken = await this.getResetTokenByToken(token);
            if (!resetToken || resetToken.used) {
                throw new Error('Invalid or used token');
            }
            const email = resetToken.email;
            const user = await Client_1.default.findBy('email', email);
            if (!user) {
                return ctx.response.status(400).json({ message: 'Invalid Token' });
            }
            user.password = password;
            await user.save();
            resetToken.used = true;
            await resetToken.save();
            return ctx.response.json({ message: 'Password updated successfully' });
        }
        catch (error) {
            return ctx.response.status(400).json(error);
        }
    }
    async getResetTokenByToken(token) {
        return ResetToken_1.default.query().where('token', token).where('used', false).firstOrFail();
    }
    async logout(ctx) {
        await ctx.auth.logout();
        return ctx.response.redirect().toPath("/");
    }
}
exports.default = AuthController;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXV0aENvbnRyb2xsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJBdXRoQ29udHJvbGxlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUVBLHFGQUFzQztBQUN0QywyRUFBaUQ7QUFFakQsNkZBQStDO0FBQy9DLG1HQUFxRDtBQUVyRCxJQUFJLFlBQVksR0FBRyxJQUFJLHNCQUFZLEVBQUUsQ0FBQTtBQUNyQyxNQUFxQixjQUFjO0lBRWpDLEtBQUssQ0FBQyxNQUFNLENBQUMsRUFBRSxJQUFJLEVBQUU7UUFFbkIsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFBO0lBQ25DLENBQUM7SUFDRCxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUUsSUFBSSxFQUFFO1FBRWxCLE9BQU8sSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQTtJQUNsQyxDQUFDO0lBS00sS0FBSyxDQUFDLGdCQUFnQixDQUFDLEVBQUUsT0FBTyxFQUFFLFFBQVEsRUFBSSxPQUFPLEVBQXVCO1FBQ2pGLElBQUk7WUFFRixNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFBO1lBR3BDLElBQUksQ0FBQyxLQUFLLEVBQUU7Z0JBQ1QsT0FBTyxDQUFDLEtBQUssQ0FBQztvQkFDYixLQUFLLEVBQUMsa0NBQWtDO2lCQUN6QyxDQUFDLENBQUE7Z0JBQ0YsT0FBTyxRQUFRLENBQUMsUUFBUSxFQUFFLENBQUMsSUFBSSxFQUFFLENBQUE7YUFDbEM7WUFHRCxNQUFNLElBQUksR0FBRyxNQUFNLGdCQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQTtZQUVoRCxJQUFJLENBQUMsSUFBSSxFQUFFO2dCQUNULE9BQU8sQ0FBQyxLQUFLLENBQUM7b0JBQ1osS0FBSyxFQUFDLHVCQUF1QjtvQkFDN0IsS0FBSyxFQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDO2lCQUM3QixD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Q0FBQyxJQUFJLEVBQUU7Z0JBQ1QsT0FBTyxHQUFHLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsZUFBZSxFQUFFLENBQUMsQ0FBQTthQUNuRTtZQUdELElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFBO1lBQ3hCLE1BQU0sSUFBSSxDQUFDLElBQUksRUFBRSxDQUFBO1lBR2pCLFVBQVUsQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFBO1lBQ3RCLE1BQU0sVUFBVSxDQUFDLElBQUksRUFBRSxDQUFBO1lBRXZCLE9BQU8sR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRSxPQUFPLEVBQUUsK0JBQStCLEVBQUUsQ0FBQyxDQUFBO1NBQ3ZFO1FBQUMsT0FBTyxLQUFLLEVBQUU7WUFFZCxPQUFPLEdBQUcsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBRSxLQUFLLENBQUcsQ0FBQTtTQUMvQztJQUNILENBQUM7SUFPTyxLQUFLLENBQUMsb0JBQW9CLENBQUMsS0FBYTtRQUM5QyxPQUFPLG9CQUFVLENBQUMsS0FBSyxFQUFFLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQyxLQUFLLENBQUMsTUFBTSxFQUFDLEtBQUssQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFBO0lBQ25GLENBQUM7SUFFTSxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQXdCO1FBQzFDLE1BQU0sR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQTtRQUN2QixPQUFPLEdBQUcsQ0FBQyxRQUFRLENBQUMsUUFBUSxFQUFFLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFBO0lBQzVDLENBQUM7Q0FFRjtBQXpKRCxpQ0F5SkMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBpbXBvcnQgdHlwZSB7IEh0dHBDb250ZXh0Q29udHJhY3QgfSBmcm9tICdAaW9jOkFkb25pcy9Db3JlL0h0dHBDb250ZXh0J1xuXG5pbXBvcnQgQ2xpZW50IGZyb20gXCJBcHAvTW9kZWxzL0NsaWVudFwiXG5pbXBvcnQge3NjaGVtYX0gZnJvbSAnQGlvYzpBZG9uaXMvQ29yZS9WYWxpZGF0b3InXG5pbXBvcnQgdHlwZSB7SHR0cENvbnRleHRDb250cmFjdH0gZnJvbSAnQGlvYzpBZG9uaXMvQ29yZS9IdHRwQ29udGV4dCdcbmltcG9ydCBSZXNldFRva2VuIGZyb20gXCJBcHAvTW9kZWxzL1Jlc2V0VG9rZW5cIjtcbmltcG9ydCBFbWFpbFNlcnZpY2UgZnJvbSBcIkFwcC9TZXJ2aWNlcy9FbWFpbFNlcnZpY2VcIjtcblxudmFyIGVtYWlsU2VydmljZSA9IG5ldyBFbWFpbFNlcnZpY2UoKVxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQXV0aENvbnRyb2xsZXIge1xuXG4gIGFzeW5jIGZvcmdvdCh7IHZpZXcgfSkge1xuXG4gICAgcmV0dXJuIHZpZXcucmVuZGVyKCdhdXRoL2ZvcmdvdCcpXG4gIH1cbiAgYXN5bmMgcmVzZXQoeyB2aWV3IH0pIHtcblxuICAgIHJldHVybiB2aWV3LnJlbmRlcignYXV0aC9yZXNldCcpXG4gIH1cbiAgLyoqXG4gICAqIEdlbmVyYXRlcyBhIHJlc2V0IHRva2VuIGZvciB0aGUgc3BlY2lmaWVkIGVtYWlsXG4gICAqIEBwYXJhbSBjdHggLSBUaGUgSFRUUCBjb250ZXh0IGNvbnRhaW5pbmcgdGhlIHJlcXVlc3QgYW5kIHJlc3BvbnNlIG9iamVjdHNcbiAgICovXG4gIHB1YmxpYyBhc3luYyBjcmVhdGVSZXNldFRva2VuKHsgcmVxdWVzdCwgcmVzcG9uc2UsICAgc2Vzc2lvbiB9OiBIdHRwQ29udGV4dENvbnRyYWN0KSB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIEV4dHJhY3QgdGhlIGVtYWlsIGZyb20gdGhlIHJlcXVlc3RcbiAgICAgIGNvbnN0IGVtYWlsID0gcmVxdWVzdC5pbnB1dCgnZW1haWwnKVxuXG4gICAgICAvLyBDaGVjayBpZiB0aGUgZW1haWwgZXhpc3RzIGluIHRoZSByZXF1ZXN0XG4gICAgICBpZiAoIWVtYWlsKSB7XG4gICAgICAgICBzZXNzaW9uLmZsYXNoKHtcbiAgICAgICAgICBlcnJvcjpcIkVtYWlsIGlzIHJlcXVpcmVkIGluIHRoZSByZXF1ZXN0XCIsXG4gICAgICAgIH0pXG4gICAgICAgIHJldHVybiByZXNwb25zZS5yZWRpcmVjdCgpLmJhY2soKVxuICAgICAgfVxuXG4gICAgICAvLyBDaGVjayBpZiB0aGUgZW1haWwgZXhpc3RzIGluIHRoZSBVc2VyIG1vZGVsXG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgQ2xpZW50LmZpbmRCeSgnZW1haWwnLCBlbWFpbClcblxuICAgICAgaWYgKCF1c2VyKSB7XG4gICAgICAgIHNlc3Npb24uZmxhc2goe1xuICAgICAgICAgIGVycm9yOlwiSW52YWxpZCBlbWFpbCBhZGRyZXNzXCIsXG4gICAgICAgICAgZW1haWw6cmVxdWVzdC5pbnB1dChcImVtYWlsXCIpLFxuICAgICAgICB9KVxuICAgICAgICByZXR1cm4gcmVzcG9uc2UucmVkaXJlY3QoKS5iYWNrKClcbiAgICAgICB9XG5cbiAgICAgIC8vIEdlbmVyYXRlIGEgcmVzZXQgdG9rZW4gdXNpbmcgdGhlIG1vZGVsIG1ldGhvZFxuICAgICAgY29uc3QgcmVzZXRUb2tlbiA9IGF3YWl0IFJlc2V0VG9rZW4uY3JlYXRlUmVzZXRUb2tlbihlbWFpbClcblxuICAgICAgLy8gWW91IGNhbiBzZW5kIHRoZSByZXNldCB0b2tlbiB0byB0aGUgdXNlciB2aWEgZW1haWwgb3Igb3RoZXIgbWVhbnNcbiAgICAgIGF3YWl0IGVtYWlsU2VydmljZS5wYXNzd29yZFJlY292ZXJ5KGVtYWlsLHJlc2V0VG9rZW4pXG4gICAgICAvLyBGb3Igbm93LCB3ZSdsbCBqdXN0IHJldHVybiBpdCBpbiB0aGUgcmVzcG9uc2VcblxuICAgICAgcmV0dXJuIHJlc3BvbnNlLnJlZGlyZWN0KCkudG9QYXRoKFwiL3Jlc2V0LXBhc3N3b3JkXCIpXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUubG9nKGVycm9yLm1lc3NhZ2UpXG4gICAgICAvLyBIYW5kbGUgZXJyb3JzLCBzdWNoIGFzIGVtYWlsIG5vdCBmb3VuZFxuICAgICAgc2Vzc2lvbi5mbGFzaCh7XG4gICAgICAgIGVycm9yOlwiVGhlcmUgd2FzIGEgdGVjaG5pY2FsIGVycm9yXCIsXG4gICAgICAgIGVtYWlsOnJlcXVlc3QuaW5wdXQoXCJlbWFpbFwiKSxcbiAgICAgIH0pXG4gICAgICByZXR1cm4gcmVzcG9uc2UucmVkaXJlY3QoKS5iYWNrKClcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhdGVzIGFuZCBwcm9jZXNzZXMgYSByZXNldCB0b2tlbiBmb3IgdGhlIHNwZWNpZmllZCBlbWFpbFxuICAgKiBAcGFyYW0gY3R4IC0gVGhlIEhUVFAgY29udGV4dCBjb250YWluaW5nIHRoZSByZXF1ZXN0IGFuZCByZXNwb25zZSBvYmplY3RzXG4gICAqL1xuICBwdWJsaWMgYXN5bmMgcHJvY2Vzc1Jlc2V0VG9rZW4oeyByZXF1ZXN0LCByZXNwb25zZSB9OiBIdHRwQ29udGV4dENvbnRyYWN0KSB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIEV4dHJhY3QgdGhlIGVtYWlsIGFuZCB0b2tlbiBmcm9tIHRoZSByZXF1ZXN0XG4gICAgICBjb25zdCBlbWFpbCA9IHJlcXVlc3QuaW5wdXQoJ2VtYWlsJylcbiAgICAgIGNvbnN0IHRva2VuID0gcmVxdWVzdC5pbnB1dCgndG9rZW4nKVxuXG4gICAgICAvLyBWYWxpZGF0ZSB0aGUgdG9rZW4gdXNpbmcgdGhlIG1vZGVsIG1ldGhvZFxuICAgICAgYXdhaXQgUmVzZXRUb2tlbi5pc1Rva2VuVmFsaWQoZW1haWwsIHRva2VuKVxuXG5cblxuICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oeyBtZXNzYWdlOiAnVG9rZW4gaXMgdmFsaWQnIH0pXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIC8vIEhhbmRsZSBlcnJvcnMsIHN1Y2ggYXMgaW52YWxpZCB0b2tlbiBvciBvdGhlciB2YWxpZGF0aW9uIGlzc3Vlc1xuICAgICAgcmV0dXJuIHJlc3BvbnNlLnN0YXR1cyg0MDApLmpzb24oeyBtZXNzYWdlOiBlcnJvci5tZXNzYWdlIH0pXG4gICAgfVxuICB9XG5cblxuXG4gIC8qKlxuICAgKiBWYWxpZGF0ZXMgYW5kIHVwZGF0ZXMgdGhlIHBhc3N3b3JkIHVzaW5nIHRoZSByZXNldCB0b2tlblxuICAgKiBAcGFyYW0gY3R4IC0gVGhlIEhUVFAgY29udGV4dCBjb250YWluaW5nIHRoZSByZXF1ZXN0IGFuZCByZXNwb25zZSBvYmplY3RzXG4gICAqL1xuICBwdWJsaWMgYXN5bmMgdXBkYXRlUGFzc3dvcmRXaXRoVG9rZW4oY3R4OiBIdHRwQ29udGV4dENvbnRyYWN0ICkge1xuICAgIHRyeSB7XG5cbiAgICAgIGNvbnN0IG5ld1Bvc3RTY2hlbWEgPSBzY2hlbWEuY3JlYXRlKHtcbiAgICAgICAgdG9rZW46IHNjaGVtYS5zdHJpbmcoKSxcbiAgICAgICAgcGFzc3dvcmQ6IHNjaGVtYS5zdHJpbmcoKSxcbiAgICAgICAgY29uZmlybV9wYXNzd29yZDpzY2hlbWEuc3RyaW5nKClcbiAgICAgIH0pXG5cbiAgICAgIGNvbnN0IHBheWxvYWQgPSBhd2FpdCBjdHgucmVxdWVzdC52YWxpZGF0ZSh7IHNjaGVtYTogbmV3UG9zdFNjaGVtYSB9KVxuXG4gICAgICAvLyBFeHRyYWN0IHRoZSB0b2tlbiwgcGFzc3dvcmQsIGFuZCBjb25maXJtX3Bhc3N3b3JkIGZyb20gdGhlIHJlcXVlc3RcbiAgICAgIGNvbnN0IHRva2VuID0gcGF5bG9hZC50b2tlblxuICAgICAgY29uc3QgcGFzc3dvcmQgPSBwYXlsb2FkLnBhc3N3b3JkXG4gICAgICBjb25zdCBjb25maXJtUGFzc3dvcmQgPSBwYXlsb2FkLmNvbmZpcm1fcGFzc3dvcmRcblxuICAgICAgaWYocGFzc3dvcmQhPT1jb25maXJtUGFzc3dvcmQpe1xuICAgICAgICByZXR1cm4gY3R4LnJlc3BvbnNlLnN0YXR1cyg0MDApLmpzb24oeyBtZXNzYWdlOlwiUGFzc3dvcmQgY29uZmlybWF0aW9uIGRvZXMgbm90IG1hdGNoLlwiIH0pXG5cbiAgICAgIH1cblxuICAgICAgLy8gUmV0cmlldmUgdGhlIHJlc2V0IHRva2VuIGluc3RhbmNlIGJ5IHRva2VuXG4gICAgICBjb25zdCByZXNldFRva2VuID0gYXdhaXQgdGhpcy5nZXRSZXNldFRva2VuQnlUb2tlbih0b2tlbilcblxuICAgICAgLy8gVmFsaWRhdGUgdGhlIHRva2VuXG4gICAgICBpZiAoIXJlc2V0VG9rZW4gfHwgcmVzZXRUb2tlbi51c2VkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBvciB1c2VkIHRva2VuJylcbiAgICAgIH1cblxuICAgICAgLy8gUmV0cmlldmUgdGhlIGVtYWlsIGFzc29jaWF0ZWQgd2l0aCB0aGUgdG9rZW5cbiAgICAgIGNvbnN0IGVtYWlsID0gcmVzZXRUb2tlbi5lbWFpbFxuXG4gICAgICAvLyBGaW5kIHRoZSB1c2VyIGJ5IGVtYWlsXG4gICAgICBjb25zdCB1c2VyID0gYXdhaXQgQ2xpZW50LmZpbmRCeSgnZW1haWwnLCBlbWFpbClcblxuICAgICAgaWYgKCF1c2VyKSB7XG4gICAgICAgIHJldHVybiBjdHgucmVzcG9uc2Uuc3RhdHVzKDQwMCkuanNvbih7IG1lc3NhZ2U6ICdJbnZhbGlkIFRva2VuJyB9KVxuICAgICAgfVxuXG4gICAgICAvLyBVcGRhdGUgdGhlIHVzZXIncyBwYXNzd29yZFxuICAgICAgdXNlci5wYXNzd29yZCA9IHBhc3N3b3JkXG4gICAgICBhd2FpdCB1c2VyLnNhdmUoKVxuXG4gICAgICAvLyBNYXJrIHRoZSByZXNldCB0b2tlbiBhcyB1c2VkXG4gICAgICByZXNldFRva2VuLnVzZWQgPSB0cnVlXG4gICAgICBhd2FpdCByZXNldFRva2VuLnNhdmUoKVxuXG4gICAgICByZXR1cm4gY3R4LnJlc3BvbnNlLmpzb24oeyBtZXNzYWdlOiAnUGFzc3dvcmQgdXBkYXRlZCBzdWNjZXNzZnVsbHknIH0pXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIC8vIEhhbmRsZSBlcnJvcnMsIHN1Y2ggYXMgaW52YWxpZCB0b2tlbiBvciBvdGhlciB2YWxpZGF0aW9uIGlzc3Vlc1xuICAgICAgcmV0dXJuIGN0eC5yZXNwb25zZS5zdGF0dXMoNDAwKS5qc29uKCBlcnJvciAgKVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBSZXRyaWV2ZXMgdGhlIHJlc2V0IHRva2VuIGluc3RhbmNlIGJ5IHRva2VuXG4gICAqIEBwYXJhbSB0b2tlbiAtIFRoZSByZXNldCB0b2tlbiB0byByZXRyaWV2ZVxuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxSZXNldFRva2VuIHwgbnVsbD59IC0gVGhlIHJlc2V0IHRva2VuIGluc3RhbmNlIG9yIG51bGwgaWYgbm90IGZvdW5kXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGdldFJlc2V0VG9rZW5CeVRva2VuKHRva2VuOiBzdHJpbmcpOiBQcm9taXNlPFJlc2V0VG9rZW4gfCBudWxsPiB7XG4gICAgcmV0dXJuIFJlc2V0VG9rZW4ucXVlcnkoKS53aGVyZSgndG9rZW4nLCB0b2tlbikud2hlcmUoJ3VzZWQnLGZhbHNlKS5maXJzdE9yRmFpbCgpXG4gIH1cblxuICBwdWJsaWMgYXN5bmMgbG9nb3V0KGN0eDogSHR0cENvbnRleHRDb250cmFjdCl7XG4gICAgYXdhaXQgY3R4LmF1dGgubG9nb3V0KClcbiAgICByZXR1cm4gY3R4LnJlc3BvbnNlLnJlZGlyZWN0KCkudG9QYXRoKFwiL1wiKVxuICB9XG5cbn1cbiJdfQ==